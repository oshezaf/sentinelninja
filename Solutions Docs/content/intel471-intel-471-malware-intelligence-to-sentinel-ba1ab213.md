# Intel 471 Malware Intelligence to Sentinel

**Browse:** [üè†](../readme.md) ¬∑ [Solutions](../solutions-index.md) ¬∑ [Connectors](../connectors-index.md) ¬∑ [Tables](../tables-index.md) ¬∑ [Content](../content/content-index.md) ¬∑ [Parsers](../parsers/parsers-index.md) ¬∑ [ASIM Parsers](../asim/asim-index.md) ¬∑ [ASIM Products](../asim/asim-products-index.md)

‚Üë [Back to Content Index](../content/content-index.md)

---

This playbook ingests malware indicators from Intel 471's Titan or Verity API into Microsoft Sentinel as tiIndicator resource type.

| Attribute | Value |
|:----------|:------|
| **Type** | Playbook |
| **Solution** | [Intel471](../solutions/intel471.md) |
| **Source** | [View on GitHub](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Intel471/Playbooks/Intel471-ImportMalwareIntelligenceToSentinel/azuredeploy.json) |

## Additional Documentation

> üìÑ *Source: [Intel471-ImportMalwareIntelligenceToSentinel/readme.md](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Intel471/Playbooks/Intel471-ImportMalwareIntelligenceToSentinel/readme.md)*

# Intel 471 Malware Intelligence import to Sentinel

## Table of contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Deployment instructions](#deployment-instructions)
4. [Post-deployment instructions](#post-deployment-instructions)
5. [Querying Intel 471 Malware Intelligence data in Sentinel](#querying-intel-471-malware-intelligence-data-in-sentinel)
6. [Data mapping](#data-mapping)
7. [Script for granting ThreatIndicators.ReadWrite.OwnedBy role](#script-for-granting-threatindicatorsreadwriteownedby-role)

## Overview

This playbook fetches malware intelligence indicators from the Intel 471's Titan or Verity API and ingests them
using [Threat Intelligence UploadStixObjects API for Microsoft Sentinel](https://learn.microsoft.com/azure/sentinel/stix-objects-api).

[azuredeploy.json](azuredeploy.json) Azure Resource Manager template (ARM template) is responsible
for building the Logic App along with the necessary connections. The ARM builds following components:

- **[Logic App](https://docs.microsoft.com/azure/sentinel/create-custom-connector#connect-with-logic-apps)** responsible for fetching the data from Titan or Verity API and ingesting them into `ThreatIntelIndicators` table using UploadStixObjects API.
- Connection objects
  - Logic app to Blob storage *(authorized automatically)*
  - Logic app to Key Vault *(**requires manual configuration**)*
  - Logic app to Log Analytics workspace *(**requires manual configuration**)*

## Prerequisites

1. An active account in Titan or Verity platform, which is available as part of Intel 471's subscriptions. For more information, please contact sales@intel471.com.
2. Titan or Verity API credentials.
3. Pre-existing [Key Vault](https://docs.microsoft.com/azure/key-vault/general/basic-concepts) for securely storing Titan or Verity API credentials. Store Titan API credentials as secrets
under `TitanUserNameSentinel` and `TitanAPIKeySentinel` keys, or Verity API credentials under `VerityUserNameSentinel` and `VerityAPIKeySentinel` keys.
4. Pre-existing [Blob storage](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-introduction) with blob container for persisting data such as cursor between the API calls.
5. Threat Intelligence connector enabled in Sentinel. Go to Sentinel instance ‚Üí `Content hub` and install `Threat Intelligence` solution.


## Deployment instructions

1. To deploy the Playbook, click the **Deploy to Azure** button. It will launch the ARM Template deployment wizard.
2. Provide following parameters:
    * **Playbook Name**: Either leave the default one or change it as needed
    * **StorageAccountName**: Name of the Storage account (see prerequisites)
    * **StorageAccountContainerName**: Name of the blob container in the Storage account
    * **KeyVaultName**: Name of the Key Vault (see prerequisites)
    * **Workspace ID**: ID of the Log Analytics workspace to which the indicators will be directed
    * **Look Back Days**: How many days of history should be pulled on the first run. Leave 0 to start from the current time
    * **Backend**: Which backend to use to pull data from ‚Äî either `Titan` or `Verity`.

    [![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FIntel471%2FPlaybooks%2FIntel471-ImportMalwareIntelligenceToSentinel%2Fazuredeploy.json)
    [![Deploy to Azure Gov](https://aka.ms/deploytoazuregovbutton)](https://portal.azure.us/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FIntel471%2FPlaybooks%2FIntel471-ImportMalwareIntelligenceToSentinel%2Fazuredeploy.json)

## Post-deployment instructions

1. Go to the Key Vault. Select `Access control (IAM)` ‚Üí `+ Add` ‚Üí `Add role assignment`. Choose `Key Vault Secrets User`. On the next screen hit `+ Select members`, search for Intel 471 and select newly created logic app. Select it and proceed with granting access rights.
2. Go to the selected Log Analytics workspace and repeat step 1. except grant role `Microsoft Sentinel Contributor`.
4. Optionally change the logic app's schedule's frequency in `Recurrence` block (the first one).

## Querying Intel 471 Malware Intelligence data in Sentinel

Get first 10 ingested indicators

```
ThreatIntelIndicators | where SourceSystem startswith "Intel 471"  | limit 10 
```

Look for a specific indicator

```
ThreatIntelIndicators | where SourceSystem startswith "Intel 471"  | where ObservableValue == "227.151.66.29"
ThreatIntelIndicators | where SourceSystem startswith "Intel 471"  | where ObservableValue == "tcp://58.68.162.115:16"
ThreatIntelIndicators | where SourceSystem startswith "Intel 471"  | where ObservableValue  == "58acf725b72ecfdbdacd532feff1c89359021e6502664147456c5b2db2a05544"
```

Get indicators of a specific type

```

*[Content truncated...]*

---

**Browse:** [üè†](../readme.md) ¬∑ [Solutions](../solutions-index.md) ¬∑ [Connectors](../connectors-index.md) ¬∑ [Tables](../tables-index.md) ¬∑ [Content](../content/content-index.md) ¬∑ [Parsers](../parsers/parsers-index.md) ¬∑ [ASIM Parsers](../asim/asim-index.md) ¬∑ [ASIM Products](../asim/asim-products-index.md)

‚Üë [Back to Playbooks](playbooks.md) ¬∑ [Back to Intel471](../solutions/intel471.md)

