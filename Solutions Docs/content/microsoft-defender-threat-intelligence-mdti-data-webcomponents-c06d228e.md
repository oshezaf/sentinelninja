# MDTI-Data-WebComponents

**Browse:** [üè†](../README.md) ¬∑ [Solutions](../solutions-index.md) ¬∑ [Connectors](../connectors-index.md) ¬∑ [Methods](../methods-index.md) ¬∑ [Tables](../tables-index.md) ¬∑ [Content](../content/content-index.md) ¬∑ [Parsers](../parsers/parsers-index.md) ¬∑ [ASIM Parsers](../asim/asim-index.md) ¬∑ [ASIM Products](../asim/asim-products-index.md) ¬∑ [üìä](../statistics.md)

‚Üë [Back to Content Index](../content/content-index.md)

---

This playbook uses the MDTI Components data to automatically enrich incidents generated by Microsoft Sentinel. Leverage this playbook in order to enrich your incidents with [Webcomponents](https://learn.microsoft.com/en-us/defender/threat-intelligence/data-sets#components) data hosted by the indicators found within the incident. These components allow a user to understand the makeup of a webpage or the technology and services driving a specific piece of infrastructure. Pivoting on unique compone

| Attribute | Value |
|:----------|:------|
| **Type** | Playbook |
| **Solution** | [Microsoft Defender Threat Intelligence](../solutions/microsoft-defender-threat-intelligence.md) |
| **Source** | [View on GitHub](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Defender%20Threat%20Intelligence/Playbooks/MDTI-Data-WebComponents/azuredeploy.json) |

## Additional Documentation

> üìÑ *Source: [MDTI-Data-WebComponents/readme.md](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Defender%20Threat%20Intelligence/Playbooks/MDTI-Data-WebComponents/readme.md)*

## Overview
This playbook uses the [Microsoft Defender Threat Intelligence](https://learn.microsoft.com/en-us/defender/threat-intelligence/what-is-microsoft-defender-threat-intelligence-defender-ti) components dataset to automatically enrich incidents generated by Microsoft Sentinel. It extracts Host and IP entities from incidents and queries MDTI Web Components data ([dataset reference](https://learn.microsoft.com/en-us/defender/threat-intelligence/data-sets#components)) to summarize technologies and components observed for the indicators. The playbook adds formatted comments to the incident so analysts can pivot quickly during investigation.

## Key Capabilities
- Trigger on new Sentinel incidents (incident creation trigger).
- Collect Host and IP entities from the incident payload.
- Query MDTI components data for hosts/IPs and build HTML summary tables.
- Generates per-host and per-IP HTML tables summarizing Web Component observations.
- Post structured comments back to the originating incident.

## Prerequisites
1. Microsoft Defender Threat Intelligence (MDTI) Premium license enabled for the tenant.
2. One of the following Azure AD roles (to grant Graph application permissions to the playbook's Managed Identity): Security Administrator, Global Administrator, or Privileged Role Administrator.

## Deployment Parameters
| Name | Description | Default |
|------|-------------|---------|
| PlaybookName | Name of the Logic App (playbook) | MDTI-Data-WebComponents |
| MDTI-BaseUrl | MDTI Graph API base URL (must start with https://) | https://graph.microsoft.com |
| Api-Version | MDTI Graph API version | v1.0 |

## Deployment

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FMicrosoft%2520Defender%2520Threat%2520Intelligence%2FPlaybooks%2FMDTI-Data-WebComponents%2Fazuredeploy.json" target="_blank">
    <img src="https://aka.ms/deploytoazurebutton" alt="Deploy to Azure"/>
</a>
<a href="https://portal.azure.us/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FAzure-Sentinel%2Fmaster%2FSolutions%2FMicrosoft%2520Defender%2520Threat%2520Intelligence%2FPlaybooks%2FMDTI-Data-WebComponents%2Fazuredeploy.json" target="_blank">
    <img src="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazuregov.png" alt="Deploy to Azure Gov">
</a>

## Post-Deployment Steps

### 1. Assign Microsoft Graph Permission (ThreatIntelligence.Read.All) to Managed Identity
To allow the playbook to query Microsoft Defender Threat Intelligence data, you must grant the managed identity of the playbook the `ThreatIntelligence.Read.All` application permission in Microsoft Graph. Follow these steps:

1. Ensure you have the necessary Azure AD permissions (Security Administrator, Global Administrator, or Privileged Role Administrator).
2. Open the [Azure Cloud Shell](https://shell.azure.com/) or use a local PowerShell session with the Microsoft Graph module installed.
3. Run the following commands, replacing `'MDTI-Data-WebComponents'` with your playbook's name if different:

```powershell
# Install the Microsoft Graph module for interacting with Microsoft Graph APIs
Install-Module Microsoft.Graph -Scope CurrentUser -AllowClobber -Force
Import-Module Microsoft.Graph

# Authenticate to Microsoft Graph using Managed Identity
Connect-MgGraph -Identity

# Retrieve the Microsoft Graph Service Principal
$graphSp = Get-MgServicePrincipal -Filter "displayName eq 'Microsoft Graph'"

# Find the ThreatIntelligence.Read.All role
$role = $graphSp.AppRoles | Where-Object { $_.Value -eq 'ThreatIntelligence.Read.All' -and $_.AllowedMemberTypes -contains 'Application' }

# Define the Logic App name (update if different)
$logicAppName = 'MDTI-Data-WebComponents'
$logicAppSp = Get-MgServicePrincipal -Filter "displayName eq '$logicAppName'"

# Assign the ThreatIntelligence.Read.All role to the Logic App's Managed Identity
New-MgServicePrincipalAppRoleAssignment -ServicePrincipalId $logicAppSp.Id `
    -PrincipalId $logicAppSp.Id `
    -ResourceId $graphSp.Id `
    -AppRoleId $role.Id

# Confirm the role assignment
Write-Host "Permission assigned successfully to Logic App ${logicAppName}."
```

**2. Authorize Connections**

After deployment, authorize all connections:

1. Click the Microsoft Sentinel connection resource
2. Click edit API connection
3. Click Authorize
4. Sign in
5. Click Save
Repeat steps for all connections.

**3. Assign Microsoft Sentinel Responder Role to Playbook**

This playbook uses a managed identity, which must have the Microsoft Sentinel Responder role assigned in the Sentinel instances to enable adding comments.

1. Select the Playbook resource.
2. In the left menu, click Identity.
3. Under Permissions, click Azure role assignments.
4. Click Add role assignment (Preview).

*[Content truncated...]*

---

**Browse:** [üè†](../README.md) ¬∑ [Solutions](../solutions-index.md) ¬∑ [Connectors](../connectors-index.md) ¬∑ [Methods](../methods-index.md) ¬∑ [Tables](../tables-index.md) ¬∑ [Content](../content/content-index.md) ¬∑ [Parsers](../parsers/parsers-index.md) ¬∑ [ASIM Parsers](../asim/asim-index.md) ¬∑ [ASIM Products](../asim/asim-products-index.md) ¬∑ [üìä](../statistics.md)

‚Üë [Back to Playbooks](playbooks.md) ¬∑ [Back to Microsoft Defender Threat Intelligence](../solutions/microsoft-defender-threat-intelligence.md)

